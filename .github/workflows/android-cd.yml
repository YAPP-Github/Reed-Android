name: Android CD

env:
    GRADLE_OPTS: "-Dorg.gradle.jvmargs=-Xmx4g -Dorg.gradle.daemon=false"
    GRADLE_BUILD_ACTION_CACHE_DEBUG_ENABLED: true

on:
    pull_request:
        branches:
            - main

jobs:
    cd-build:
        runs-on: ubuntu-latest

        steps:
            -   name: Checkout
                uses: actions/checkout@v4
                with:
                    # ìµœê·¼ íƒœê·¸ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ í•„ìš”
                    fetch-depth: 0

            -   name: Set up JDK 17
                uses: actions/setup-java@v4
                with:
                    distribution: 'corretto'
                    java-version: 17

            -   name: Generate reed.jks
                run: echo '${{ secrets.REED_JAVA_KEYSTORE }}' | base64 -d > ./reed.jks

            -   name: Generate local.properties
                run: |
                    echo '${{ secrets.LOCAL_PROPERTIES }}' >> ./local.properties

            -   name: Generate keystore.properties
                run: |
                    echo '${{ secrets.KEYSTORE_PROPERTIES }}' >> ./keystore.properties

            -   name: Generate google-services.json
                run: echo '${{ secrets.GOOGLE_SERVICES }}' | base64 -d > ./app/google-services.json

            -   name: Extract Version Name from ApplicationConstants.kt
                run: |
                    set -euo pipefail
                    VERSION=$(grep "VERSION_NAME" build-logic/src/main/kotlin/com/ninecraft/booket/convention/ApplicationConstants.kt | sed -E 's/.*VERSION_NAME\s*=\s*"([^"]+)".*/\1/')
                    if [[ -z "$VERSION" ]]; then
                      echo "Error: ApplicationConstants.ktì—ì„œ VERSION_NAME ê°’ì„ ì¶”ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤." >&2
                      exit 1
                    fi
                    echo "version=v${VERSION}" >> "$GITHUB_OUTPUT"
                    echo "Version extracted from ApplicationConstants.kt: v${VERSION}"
                id: extract_version

            -   name: Generate Firebase Release Note
                id: firebase_release_note
                env:
                    PR_TITLE: ${{ github.event.pull_request.title }}
                run: |
                    # PR_TITLEì€ envì—ì„œ ì•ˆì „í•˜ê²Œ ì „ë‹¬ë¨
                    # ê°€ì¥ ìµœê·¼ íƒœê·¸ ì°¾ê¸° (í˜„ì¬ ë²„ì „ ì´ì „ì˜ íƒœê·¸)
                    LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

                    # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ë‚´ìš© ìƒì„±
                    NOTES="## ğŸš€ ë³€ê²½ì‚¬í•­: ${PR_TITLE}\n\n"

                    if [ -n "$LATEST_TAG" ]; then
                        NOTES="${NOTES}### ì´ì „ ë²„ì „($LATEST_TAG)ë¶€í„°ì˜ ë³€ê²½ì‚¬í•­:\n"
                        # ìµœê·¼ íƒœê·¸ë¶€í„° í˜„ì¬ê¹Œì§€ì˜ ì»¤ë°‹ë§Œ ê°€ì ¸ì˜´
                        COMMITS=$(git log --pretty=format:"- %h %s (%an)" ${LATEST_TAG}..HEAD --no-merges)
                        NOTES="${NOTES}${COMMITS}"
                    else
                        NOTES="${NOTES}### ì»¤ë°‹ ë‚´ì—­:\n"
                        # íƒœê·¸ê°€ ì—†ëŠ” ê²½ìš° ìµœê·¼ 10ê°œ ì»¤ë°‹ë§Œ í‘œì‹œ
                        COMMITS=$(git log --pretty=format:"- %h %s (%an)" --no-merges -n 10)
                        NOTES="${NOTES}${COMMITS}\n\n(ì´ì „ ë¦´ë¦¬ìŠ¤ íƒœê·¸ê°€ ì—†ì–´ ìµœê·¼ 10ê°œ ì»¤ë°‹ë§Œ í‘œì‹œ)"
                    fi

                    # í™˜ê²½ ë³€ìˆ˜ë¡œ ì €ì¥
                    echo "notes<<EOF" >> $GITHUB_OUTPUT
                    echo -e "$NOTES" >> $GITHUB_OUTPUT
                    echo "EOF" >> $GITHUB_OUTPUT

            -   name: Build Release AAB
                run: |
                    ./gradlew :app:bundleRelease

            -   name: Upload Release Build to Artifacts
                uses: actions/upload-artifact@v4
                with:
                    name: release-artifacts
                    path: app/build/outputs/bundle/release/
                    if-no-files-found: error

            -   name: Create Github Release
                uses: softprops/action-gh-release@v2
                with:
                    tag_name: ${{ steps.extract_version.outputs.version }}
                    release_name: ${{ steps.extract_version.outputs.version }}
                    generate_release_notes: true

            -   name: Upload artifact to Firebase App Distribution
                uses: wzieba/Firebase-Distribution-Github-Action@v1
                with:
                    appId: ${{secrets.FIREBASE_RELEASE_APP_ID}}
                    serviceCredentialsFileContent: ${{ secrets.CREDENTIAL_FILE_CONTENT }}
                    groups: testers
                    file: app/build/outputs/bundle/release/app-release.aab
                    releaseNotes: ${{ steps.firebase_release_note.outputs.notes }}
